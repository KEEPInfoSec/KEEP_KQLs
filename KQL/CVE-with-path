// KEEP Information Security Services - https://www.wearekeep.co.uk //
// Query a particualr CVE and find the DiskPath(s) on devices of said software //

let targetCveId = "CVE-2024-52316"; // Define the CVE ID you want to search for
// Retrieve devices active within the last 1 day (or adjust the time range as needed)
let AffectedDevices = DeviceInfo
| where Timestamp >= ago(1d) // Adjust time range as needed
| project DeviceId, DeviceName, OSPlatform, OSBuild, DeviceType, DeviceManualTags, OSVersionInfo; // Include additional relevant columns
// Join with DeviceTvmSoftwareVulnerabilities to filter by the specified CVE ID
let DevicesAffectedByCVE = AffectedDevices
| join kind=inner (
    DeviceTvmSoftwareVulnerabilities
    | where CveId == targetCveId // Filter for the specific CVE ID
    | project DeviceId, CveId, SoftwareVersion, SoftwareVendor, SoftwareName 
) on DeviceId
| project-away CveId; // Remove redundant CveId column
// Join to get the file paths of the vulnerable software
let DevicesWithSoftwarePaths = DevicesAffectedByCVE
| join kind=inner (
         DeviceTvmSoftwareEvidenceBeta// DeviceTvmSoftwareInventory
        | where targetCveId == targetCveId // Ensure the CVE matches
    | project DeviceId, SoftwareName, DiskPaths, SoftwareVersion  // Get the software name and file path
) on DeviceId and SoftwareName;
// Join with DeviceNetworkInfo to get the IP addresses
let DevicesWithIPs = DevicesWithSoftwarePaths
| join kind=leftouter (
    DeviceNetworkInfo
    | where Timestamp >= ago(1d) // Adjust the time range for network info if needed
    | project DeviceId, IPAddresses, IPv4Dhcp // Get the DeviceId and IP address
) on DeviceId;
// Summarize to avoid duplicate DeviceName entries and include the IP address and other relevant information
DevicesWithIPs
| summarize 
    DeviceId = any(DeviceId), 
    OSPlatform = any(OSPlatform), 
    OSVersion = any(OSVersionInfo),
    DeviceManualTags = any(DeviceManualTags), 
    DeviceType = any(DeviceType),
    SoftwareVersion = any(SoftwareVersion), 
    SoftwareVendor = any(SoftwareVendor),
    SoftwareName = any(SoftwareName),
    IPAddress = any(IPAddresses), // Include the IP address
    IPV4 = any(IPv4Dhcp),
    DiskPath = any(DiskPaths[0])
by DeviceName; // Summarize by DeviceName to avoid duplicates
